<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: hooks/useCurrentUser.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: hooks/useCurrentUser.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// hooks/useCurrentUser.js
import { useEffect, useState } from 'react';
import { apiFoodTrucks } from '../utils/api';
import { getStoredUser } from '../utils/session';

// normaliza campos desde distintas formas posibles
function mapUser(u) {
  if (!u) return null;
  return {
    id: u.id ?? u.usuario_id ?? null,
    nombre_completo: u.nombre_completo ?? '',
    email: u.email ?? '',
    rol_id: u.rol_id ?? null,
    rol_nombre: u.rol_nombre ?? u.rol ?? u.role ?? '',
    sucursal_id: u.sucursal_id ?? null,
    sucursal_nombre: u.sucursal_nombre ?? '',
    avatar: u.avatar ?? '',
    // por si más adelante quieres todo el objeto crudo
    _raw: u,
  };
}

/**
 * Lee el usuario logueado desde localStorage.
 * Si faltan `rol_nombre` o `nombre_completo`, intenta refrescar desde la API:
 *   GET v1/usuarios/  (y matchea por id o email)
 */
export function useCurrentUser({ refreshFromApiIfIncomplete = true } = {}) {
  const [user, setUser] = useState(null);
  const [loadingUser, setLoadingUser] = useState(true);
  const [errorUser, setErrorUser] = useState('');

  useEffect(() => {
    (async () => {
      setLoadingUser(true);
      setErrorUser('');
      try {
        // 1) desde storage
        const stored = mapUser(getStoredUser());
        setUser(stored);

        // 2) refresco opcional si faltan datos críticos
        const needsRefresh =
          refreshFromApiIfIncomplete &amp;&amp;
          (!stored?.rol_nombre || !stored?.nombre_completo);

        if (needsRefresh) {
          const res = await apiFoodTrucks.get('v1/usuarios/');
          const list = Array.isArray(res?.data?.results)
            ? res.data.results
            : Array.isArray(res?.results)
            ? res.results
            : Array.isArray(res)
            ? res
            : [];

          let match = null;
          if (stored?.id) {
            match = list.find((u) => (u.id ?? u.usuario_id) === stored.id);
          }
          if (!match &amp;&amp; stored?.email) {
            match = list.find((u) => u.email === stored.email);
          }
          if (match) {
            const mapped = mapUser(match);
            setUser(mapped);
            // opcional: re-grabar currentUser completo
            localStorage.setItem('currentUser', JSON.stringify(match));
          }
        }
      } catch (e) {
        setErrorUser(e?.message || 'No se pudo obtener el usuario actual');
      } finally {
        setLoadingUser(false);
      }
    })();
  }, [refreshFromApiIfIncomplete]);

  return { user, loadingUser, errorUser, setUser };
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#buildUpdateJson">buildUpdateJson</a></li><li><a href="global.html#extractId">extractId</a></li><li><a href="global.html#fetchProducto">fetchProducto</a></li><li><a href="global.html#fileFromDataUrl">fileFromDataUrl</a></li><li><a href="global.html#mapProductFromApi">mapProductFromApi</a></li><li><a href="global.html#mapProductToApi">mapProductToApi</a></li><li><a href="global.html#normalizeEstado">normalizeEstado</a></li><li><a href="global.html#normalizeMoneyString">normalizeMoneyString</a></li><li><a href="global.html#pickList">pickList</a></li><li><a href="global.html#pickObject">pickObject</a></li><li><a href="global.html#toWebpFile">toWebpFile</a></li><li><a href="global.html#unwrapResponse">unwrapResponse</a></li><li><a href="global.html#uploadImagenProducto">uploadImagenProducto</a></li><li><a href="global.html#useCurrentUser">useCurrentUser</a></li><li><a href="global.html#waitForImagenUrl">waitForImagenUrl</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sun Nov 02 2025 00:16:43 GMT-0300 (hora de verano de Chile)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
